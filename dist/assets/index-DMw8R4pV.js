(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const l of i.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function e(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=e(a);fetch(a.href,i)}})();class C{getActiveGamepad(){const t=Object.keys(this.controllers);return t.length>0?this.controllers[t[0]]:null}constructor(){this.controllers={},this.animationFrameId=null,this.listeners={frame:[],connect:[],disconnect:[]},window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this)),this.checkInterval=setInterval(this.scanGamepads.bind(this),500),window.addEventListener("click",()=>this.scanGamepads()),window.addEventListener("keydown",()=>this.scanGamepads())}scanGamepads(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)t[e]&&!this.controllers[t[e].index]&&this.onGamepadConnected({gamepad:t[e]})}handleConnect(t){this.onGamepadConnected({gamepad:t})}handleDisconnect(t){this.onGamepadDisconnected({gamepad:t})}onGamepadConnected(t){console.log("Gamepad connected",t.gamepad),this.controllers[t.gamepad.index]=t.gamepad,this.emit("connect",t.gamepad),Object.keys(this.controllers).length===1&&!this.animationFrameId&&(this.startPolling(),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null))}onGamepadDisconnected(t){console.log("Gamepad disconnected",t.gamepad),delete this.controllers[t.gamepad.index],this.emit("disconnect",t.gamepad),Object.keys(this.controllers).length===0&&this.stopPolling()}startPolling(){const t=()=>{this.poll(),this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}stopPolling(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}poll(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)if(t[e]){this.controllers[t[e].index]=t[e],this.emit("frame",t[e]);break}}on(t,e){this.listeners[t]&&this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(s=>s(e))}}class R{constructor(){this.mappings={},this.addMapping("03000000c82d000009600000","8BitDo Pro 3","a:b0,b:b1,x:b2,y:b3,back:b6,start:b7,guide:b8,leftstick:b9,rightstick:b10,leftshoulder:b4,rightshoulder:b5,dpup:h0.1,dpdown:h0.4,dpleft:h0.8,dpright:h0.2,leftx:a0,lefty:a1,rightx:a3,righty:a4,lefttrigger:a2,righttrigger:a5"),this.addMapping("2dc8-6009","8BitDo Pro 3 (User Config)","a:b0,b:b1,x:b2,y:b3,back:b10,start:b11,leftstick:b12,rightstick:b13,leftshoulder:b6,rightshoulder:b7,dpup:h0.1,dpdown:h0.4,dpleft:h0.8,dpright:h0.2,leftx:a0,lefty:a1,rightx:a2,righty:a3,lefttrigger:a4,righttrigger:a5"),this.loadFromStorage()}addMapping(t,e,s){this.mappings[t.toLowerCase()]=this.parseMapping(s)}loadFromStorage(){try{const t=localStorage.getItem("custom_gamepad_mapping");if(t){const e=JSON.parse(t);e.key&&e.mapping&&(console.log("Loaded custom mapping for:",e.key),this.addMapping(e.key,e.name,e.mapping))}}catch(t){console.error("Failed to load custom mapping",t)}}findMapping(t){const e=t.id.toLowerCase(),s=e.match(/vendor:\s*([0-9a-f]{4})/),a=e.match(/product:\s*([0-9a-f]{4})/);if(s&&a){const i=`${s[1]}-${a[1]}`;if(this.mappings[i])return this.mappings[i]}return null}parseMapping(t){const e={buttons:{},axes:{}};return t.split(",").forEach(a=>{if(!a.includes(":"))return;const[i,l]=a.split(":");l.startsWith("b")?e.buttons[i]=parseInt(l.substring(1)):l.startsWith("a")?e.axes[i]=parseInt(l.substring(1)):l.startsWith("h")&&(e.buttons[i]={type:"hat",val:l})}),e}apply(t,e,s){}getIndices(t){const e=this.findMapping(t);return e?{axes:{lx:e.axes.leftx??0,ly:e.axes.lefty??1,rx:e.axes.rightx??2,ry:e.axes.righty??3,lt:e.axes.lefttrigger,rt:e.axes.righttrigger},buttons:{south:e.buttons.a??0,east:e.buttons.b??1,west:e.buttons.x??2,north:e.buttons.y??3,lb:e.buttons.leftshoulder??4,rb:e.buttons.rightshoulder??5,select:e.buttons.back??8,start:e.buttons.start??9,l3:e.buttons.leftstick??10,r3:e.buttons.rightstick??11,lt:e.buttons.lefttrigger,rt:e.buttons.righttrigger}}:null}}class M{constructor(){this.DEADZONE=.5,this.TRIGGER_THRESHOLD=.1,this.mappings=new R}map(t){var f,p;if(!t)return null;const e=this.mappings.getIndices(t)||this.getDefaultIndices(t),s=n=>{if(n==null)return!1;if(typeof n=="number"){const u=t.buttons[n];return u&&(u.pressed||u.value>.5)}if(typeof n=="string"){if(n.startsWith("h"))return!1;let u=0,g=0;if(n.startsWith("+a"))u=parseInt(n.slice(2)),g=1;else if(n.startsWith("-a"))u=parseInt(n.slice(2)),g=-1;else if(n.startsWith("a"))u=parseInt(n.slice(1)),g=0;else return!1;const y=t.axes[u];return g===1?y>.5:g===-1?y<-.5:Math.abs(y)>.5}return!1},a=n=>{var x;let u=(x=e.buttons.dpad)==null?void 0:x[n];if(u!==void 0)return s(u);const g=t.axes[6],y=t.axes[7];return n==="left"&&g<-.5||n==="right"&&g>.5||n==="up"&&y<-.5||n==="down"&&y>.5},i=n=>n!==void 0&&t.axes[n]!==void 0?t.axes[n]:0,l=i(e.axes.lx),o=i(e.axes.ly),h=i(e.axes.rx),b=i(e.axes.ry);let c=0,d=0;if(e.axes.lt!==void 0){let n=i(e.axes.lt);n>-1&&(c=(n+1)/2)}else if(e.buttons.lt!==void 0){const n=e.buttons.lt;if(typeof n=="number")c=((f=t.buttons[n])==null?void 0:f.value)||0;else if(typeof n=="string"&&n.startsWith("a")){const u=parseInt(n.replace(/[^0-9]/g,""));let g=i(u);g>-1&&(c=(g+1)/2)}}if(e.axes.rt!==void 0){let n=i(e.axes.rt);n>-1&&(d=(n+1)/2)}else if(e.buttons.rt!==void 0){const n=e.buttons.rt;if(typeof n=="number")d=((p=t.buttons[n])==null?void 0:p.value)||0;else if(typeof n=="string"&&n.startsWith("a")){const u=parseInt(n.replace(/[^0-9]/g,""));let g=i(u);g>-1&&(d=(g+1)/2)}}return{mode:{raw:{lt:c,rt:d},leftTrigger:c>this.TRIGGER_THRESHOLD,rightTrigger:d>this.TRIGGER_THRESHOLD,bothTriggers:c>this.TRIGGER_THRESHOLD&&d>this.TRIGGER_THRESHOLD},sticks:{left:this.processStick(l,o),right:this.processStick(h,b)},buttons:{south:s(e.buttons.south),east:s(e.buttons.east),west:s(e.buttons.west),north:s(e.buttons.north),lb:s(e.buttons.lb),rb:s(e.buttons.rb),select:s(e.buttons.select),start:s(e.buttons.start),l3:s(e.buttons.l3),r3:s(e.buttons.r3),dpad:{up:a("up"),down:a("down"),left:a("left"),right:a("right")}}}}getDefaultIndices(t){return{axes:{lx:0,ly:1,rx:2,ry:3,lt:void 0,rt:void 0},buttons:{south:0,east:1,west:2,north:3,lb:4,rb:5,lt:6,rt:7,select:8,start:9,l3:10,r3:11,dpad:{up:12,down:13,left:14,right:15}}}}processStick(t,e){const s=Math.sqrt(t*t+e*e);if(s<this.DEADZONE)return{x:0,y:0,angle:0,magnitude:0,active:!1,sector:null};let i=Math.atan2(e,t)*(180/Math.PI);return i+=90,i<0&&(i+=360),{x:t,y:e,angle:i,magnitude:s,active:!0,sector:this.getSector(i)}}getSector(t){return t>=360-22.5||t<0+22.5?"NORTH":t>=45-22.5&&t<45+22.5?"NORTH_EAST":t>=90-22.5&&t<90+22.5?"EAST":t>=135-22.5&&t<135+22.5?"SOUTH_EAST":t>=180-22.5&&t<180+22.5?"SOUTH":t>=225-22.5&&t<225+22.5?"SOUTH_WEST":t>=270-22.5&&t<270+22.5?"WEST":t>=315-22.5&&t<315+22.5?"NORTH_WEST":null}}class L{constructor(t=2e3){this.logs=[],this.maxSize=t,this.startTime=Date.now()}log(t,e,s=null){const a=Date.now()-this.startTime;this.logs.push({timestamp:a,category:t,message:e,data:s?JSON.parse(JSON.stringify(s)):null}),this.logs.length>this.maxSize&&this.logs.shift()}export(){return this.logs.map(t=>{const e=t.data?` | ${JSON.stringify(t.data)}`:"";return`[${t.timestamp}ms] [${t.category}] ${t.message}${e}`}).join(`
`)}clear(){this.logs=[],this.startTime=Date.now()}}const T=new L;class w{constructor(){this.mapper=new M,this.state={mode:"ONSET",text:"",caseMode:0,syllable:{onset:null,vowel:null,coda:null},lastInput:null,pendingChar:null,pendingStick:null,onsetOwner:null,leftStick:{sector:null,enterTime:0,locked:!1},rightStick:{sector:null,enterTime:0,locked:!1},modeSwitchTime:0},this.DWELL_THRESHOLD=60,this.onsetConflictMode="COMMIT",this.mappings={ONSET:{LEFT:{NORTH:"h",NORTH_EAST:"k",EAST:"t",SOUTH_EAST:"c",SOUTH:"f",SOUTH_WEST:"s",WEST:"n",NORTH_WEST:"l"},RIGHT:{NORTH:"y",NORTH_EAST:"g",EAST:"d",SOUTH_EAST:"z",SOUTH:"b",SOUTH_WEST:"x",WEST:"m",NORTH_WEST:"w"}},RIME:{VOWELS:{NORTH:"i",NORTH_EAST:"û",EAST:"u",SOUTH_EAST:"ô",SOUTH:"o",SOUTH_WEST:"e",WEST:"ê",NORTH_WEST:"î"},CODA:{NORTH:"k",EAST:"t",SOUTH_EAST:"c",SOUTH_WEST:"s",WEST:"n",NORTH_WEST:"l"}},PUNCTUATION:{LEFT:{NORTH:";",NORTH_EAST:"“",EAST:"¿",SOUTH_EAST:",",SOUTH:"«",SOUTH_WEST:"<",WEST:null,NORTH_WEST:null},RIGHT:{NORTH:":",NORTH_EAST:"”",EAST:"?",SOUTH_EAST:".",SOUTH:"»",SOUTH_WEST:">"}}}}processFrame(t){const e=this.mapper.map(t);if(!e)return null;let s="ONSET";if(e.mode.bothTriggers?s="PUNCTUATION":e.mode.leftTrigger?s="RIME_LEFT":e.mode.rightTrigger&&(s="RIME_RIGHT"),this.state.mode!==s){if(s==="ONSET"&&(this.state.mode==="RIME_LEFT"||this.state.mode==="RIME_RIGHT")){let i=this.getFormattedSyllable();i.length>0&&(this.typeCharacter(i),this.consumeShift()),this.clearSyllable()}this.state.mode=s,this.state.modeSwitchTime=Date.now()}return this.handleStickInput(e,this.state.lastInput),this.handleButtons(e,this.state.lastInput),this.state.lastInput=e,this.state}handleStickInput(t,e){if(!e)return;const s=Date.now(),a=(i,l,o)=>{const h=t.sticks[i],b=e.sticks[i],c=this.state[`${i}Stick`];if(h.active||(c.locked&&T.log("STICK",`${i} Unlocked`),c.locked=!1),!c.locked){if(h.active&&h.sector){if(c.sector!==h.sector)c.sector=h.sector,c.enterTime=s;else if(s-c.enterTime>this.DWELL_THRESHOLD&&c.enterTime>this.state.modeSwitchTime){if(this.state.mode==="ONSET"&&l==="onset"){const p=i==="left"?"right":"left",n=this.state[`${p}Stick`],u=t.sticks[p];if(u&&u.active&&!n.locked&&this.state.syllable.onset&&c.enterTime>n.enterTime){if(this.state.onsetOwner===i){T.log("CONFLICT_SELF",`Ignored bounce for ${i} (Owner)`);return}if(T.log("CONFLICT",`New: ${i}, Old: ${p}. Mode: ${this.onsetConflictMode}`),this.onsetConflictMode==="IGNORE")return;this.onsetConflictMode==="COMMIT"?(T.log("CONFLICT_COMMIT",`Committed ${this.state.syllable.onset}o`),this.typeCharacter(this.state.syllable.onset+"o"),this.clearSyllable(),this.consumeShift(),n.locked=!0,n.sector=null,T.log("LOCK",`${p} Locked`)):this.onsetConflictMode==="SWITCH"&&(T.log("CONFLICT_SWITCH",`Switched to ${i}`),this.clearSyllable())}}const f=o[h.sector];f&&(this.state.syllable[l]=f,l==="onset"&&(this.state.onsetOwner=i))}}else c.sector=null,c.enterTime=0,this.state.mode.startsWith("RIME")&&(this.state.syllable[l]=null);if(b.active&&!h.active&&this.state.mode==="ONSET"&&l==="onset"&&this.state.syllable.onset&&this.state.onsetOwner===i){let d=this.getFormattedSyllable();this.typeCharacter(d+"o"),this.clearSyllable(),this.consumeShift()}}};this.state.mode==="ONSET"?(a("left","onset",this.mappings.ONSET.LEFT),a("right","onset",this.mappings.ONSET.RIGHT),this.state.syllable.vowel=null,this.state.syllable.coda=null):this.state.mode==="RIME_LEFT"?(a("left","vowel",this.mappings.RIME.VOWELS),a("right","coda",this.mappings.RIME.CODA)):this.state.mode==="RIME_RIGHT"?(a("right","vowel",this.mappings.RIME.VOWELS),a("left","coda",this.mappings.RIME.CODA)):this.state.mode==="PUNCTUATION"&&(a("left","onset",this.mappings.PUNCTUATION.LEFT),a("right","onset",this.mappings.PUNCTUATION.RIGHT))}handleButtons(t,e){if(!e)return;const s=a=>t.buttons[a]&&!e.buttons[a];s("south")&&this.typeCharacter(" "),s("east")&&this.typeCharacter(`
`),s("west")&&this.deleteCharacter(),(s("l3")||s("r3"))&&(this.state.caseMode=(this.state.caseMode+1)%3,console.log("Case Mode:",["LOWER","SHIFT","CAPS"][this.state.caseMode]),this.forceUpdateBuffer())}forceUpdateBuffer(){["left","right"].forEach(t=>{var s;const e=(s=this.state.lastInput)==null?void 0:s.sticks[t];e&&e.active&&e.sector&&(this.state[`${t}Stick`].sector,e.sector)})}getFormattedSyllable(){const t=this.state.syllable,e=this.state.caseMode;let s=t.onset||"",a=t.vowel||"",i=t.coda||"";if(!s&&!a&&!i)return"";if(e===2)return(s+a+i).toUpperCase();if(e===1){if(s)return s.toUpperCase()+a+i;if(a)return a.toUpperCase()+i;if(i)return i.toUpperCase()}return s+a+i}typeCharacter(t){this.state.text+=t,console.log("Typed:",t)}deleteCharacter(){this.state.text=this.state.text.slice(0,-1)}consumeShift(){this.state.caseMode===1&&(this.state.caseMode=0)}clearSyllable(){this.state.syllable={onset:null,vowel:null,coda:null},this.state.onsetOwner=null}}class _{constructor(t){this.container=document.getElementById(t),this.leftJoy=this.container.querySelector("#left-joy"),this.rightJoy=this.container.querySelector("#right-joy"),this.createRadialSegments(this.leftJoy,"left"),this.createRadialSegments(this.rightJoy,"right")}createRadialSegments(t,e){const s=["NORTH","NORTH_EAST","EAST","SOUTH_EAST","SOUTH","SOUTH_WEST","WEST","NORTH_WEST"],a=document.createElement("div");a.className="segment-container",s.forEach((i,l)=>{const o=document.createElement("div");o.className=`segment segment-${l}`,o.dataset.sector=i;const h=document.createElement("span");h.className="segment-label",o.appendChild(h),a.appendChild(o)}),t.appendChild(a)}update(t,e,s){t&&(this.updateJoystick(this.leftJoy,t.sticks.left,e,s,"left"),this.updateJoystick(this.rightJoy,t.sticks.right,e,s,"right"))}updateJoystick(t,e,s,a,i){const l=t.querySelector(".stick-point"),o=30,h=e.x*o,b=e.y*o;l.style.transform=`translate(${h}px, ${b}px)`;const c=t.querySelectorAll(".segment");if(c.forEach(f=>{f.classList.remove("active");const p=f.querySelector(".segment-label");p.textContent=""}),e.active&&e.sector){const f=t.querySelector(`.segment[data-sector="${e.sector}"]`);f&&f.classList.add("active")}let d=null;s==="ONSET"?d=a.ONSET[i.toUpperCase()]:s==="RIME_LEFT"?(i==="left"&&(d=a.RIME.VOWELS),i==="right"&&(d=a.RIME.CODA)):s==="RIME_RIGHT"?(i==="right"&&(d=a.RIME.VOWELS),i==="left"&&(d=a.RIME.CODA)):s==="PUNCTUATION"&&(d=a.PUNCTUATION[i.toUpperCase()]),d&&c.forEach(f=>{const p=f.dataset.sector,n=d[p];n&&(f.querySelector(".segment-label").textContent=n.toUpperCase())})}}class H{constructor(t,e,s){this.gamepadManager=t,this.inputMapper=e,this.onClose=s,this.allSteps=[{id:"south",label:"Bottom Face Button (A/Cross)"},{id:"east",label:"Right Face Button (B/Circle)"},{id:"west",label:"Left Face Button (X/Square)"},{id:"north",label:"Top Face Button (Y/Triangle)"},{id:"lb",label:"Left Bumper (L1)"},{id:"rb",label:"Right Bumper (R1)"},{id:"lt",label:"Left Trigger (L2) - Press Fully",type:"trigger"},{id:"rt",label:"Right Trigger (R2) - Press Fully",type:"trigger"},{id:"select",label:"Select / Back / View"},{id:"start",label:"Start / Menu"},{id:"l3",label:"Left Stick Click (L3)"},{id:"r3",label:"Right Stick Click (R3)"},{id:"dpad_up",label:"D-Pad Up"},{id:"dpad_down",label:"D-Pad Down"},{id:"dpad_left",label:"D-Pad Left"},{id:"dpad_right",label:"D-Pad Right"},{id:"lx",label:"Move Left Stick Left",type:"axis_neg"},{id:"ly",label:"Move Left Stick Up",type:"axis_neg"},{id:"rx",label:"Move Right Stick Left",type:"axis_neg"},{id:"ry",label:"Move Right Stick Up",type:"axis_neg"}],this.queue=[],this.skippedQueue=[],this.currentStep=null,this.calibrationData={buttons:{},axes:{}},this.isCalibrating=!1,this.state="IDLE",this.releaseCode=null,this.axisBaselines=[],this.modal=document.getElementById("calibration-modal"),this.prompt=document.getElementById("calibration-prompt"),this.skipBtn=document.getElementById("cal-skip"),this.cancelBtn=document.getElementById("cal-cancel"),this.visuals=document.querySelectorAll(".vis-btn, .vis-stick, .vis-dpad"),this.skipBtn.addEventListener("click",()=>{this.state==="INITIAL_RELEASE"?(this.updateBaselines(),this.nextStep()):this.skipStep()}),this.cancelBtn.addEventListener("click",()=>this.stop())}start(){this.isCalibrating=!0,this.calibrationData={buttons:{},axes:{}},this.queue=[...this.allSteps],this.skippedQueue=[],this.state="INITIAL_RELEASE",this.releaseCode=null,this.updateBaselines(),this.modal.style.display="flex",this.visuals.forEach(t=>{t.className=t.className.replace(/active|skipped|flash-error/g,"").trim()}),this.prompt.textContent="Checking for stuck inputs...",this.updateSkipButton("Force Start")}updateBaselines(){const t=this.gamepadManager.getActiveGamepad();t?this.axisBaselines=t.axes.map(e=>e):this.axisBaselines=[]}stop(){this.isCalibrating=!1,this.state="IDLE",this.modal.style.display="none",this.onClose&&this.onClose()}save(){const t=[],e={south:"a",east:"b",west:"x",north:"y",lb:"leftshoulder",rb:"rightshoulder",lt:"lefttrigger",rt:"righttrigger",select:"back",start:"start",l3:"leftstick",r3:"rightstick",dpad_up:"dpup",dpad_down:"dpdown",dpad_left:"dpleft",dpad_right:"dpright",lx:"leftx",ly:"lefty",rx:"rightx",ry:"righty"};for(const[i,l]of Object.entries(this.calibrationData.buttons)){const o=e[i];o&&t.push(`${o}:${l}`)}for(const[i,l]of Object.entries(this.calibrationData.axes)){const o=e[i];o&&t.push(`${o}:${l}`)}const s=t.join(","),a=this.gamepadManager.getActiveGamepad();if(a){const i=a.id.toLowerCase(),l=i.match(/vendor:\s*([0-9a-f]{4})/),o=i.match(/product:\s*([0-9a-f]{4})/);let h="user-custom";l&&o&&(h=`${l[1]}-${o[1]}`),localStorage.setItem("custom_gamepad_mapping",JSON.stringify({key:h,name:"User Calibrated",mapping:s})),this.inputMapper.mappings.loadFromStorage()}this.stop()}nextStep(){if(this.queue.length===0)if(this.skippedQueue.length>0)alert("Revisiting skipped buttons. Please map them now."),this.queue=[...this.skippedQueue],this.skippedQueue=[];else{this.save();return}this.currentStep=this.queue.shift(),this.state="WAITING_FOR_INPUT",this.updateSkipButton("Skip"),this.renderStep()}updateSkipButton(t){this.skipBtn&&(this.skipBtn.textContent=t)}skipStep(){if(!this.currentStep)return;const t=this.getVisSelector(this.currentStep.id);if(t){const e=this.modal.querySelector(t);e&&(e.classList.remove("active"),e.classList.add("skipped"))}this.skippedQueue.push(this.currentStep),this.nextStep()}renderStep(){if(!this.currentStep)return;this.prompt.textContent=this.currentStep.label;const t=this.getVisSelector(this.currentStep.id);if(t){const e=this.modal.querySelector(t);e.classList.remove("skipped"),e.classList.add("active")}}getVisSelector(t){return{south:".vis-a",east:".vis-b",west:".vis-x",north:".vis-y",lb:".vis-l-shoulder",rb:".vis-r-shoulder",lt:".vis-l-trigger",rt:".vis-r-trigger",select:".vis-select",start:".vis-start",l3:".vis-l-stick",r3:".vis-r-stick",dpad_up:".vis-dpad",dpad_down:".vis-dpad",dpad_left:".vis-dpad",dpad_right:".vis-dpad",lx:".vis-l-stick",ly:".vis-l-stick",rx:".vis-r-stick",ry:".vis-r-stick"}[t]}getAxisDelta(t,e){if(!this.axisBaselines[e]&&this.axisBaselines[e]!==0)return 0;const s=t.axes[e],a=this.axisBaselines[e];return Math.abs(s-a)}handleInput(t){if(this.isCalibrating){if(this.state==="INITIAL_RELEASE"){let e=null;for(let s=0;s<t.buttons.length;s++)if(t.buttons[s].pressed){e=`Button ${s}`;break}if(!e){for(let s=0;s<t.axes.length;s++)if(this.getAxisDelta(t,s)>.5){e=`Axis ${s} Moved`;break}}e?this.prompt.textContent=`Input Detected: [${e}]. Release or press 'Force Start'.`:this.nextStep();return}if(this.currentStep){if(this.state==="WAITING_FOR_RELEASE"){this.prompt.textContent="Release Button...";let e=!1;if(this.releaseCode.includes("b")){if(this.releaseCode.startsWith("b")){const s=parseInt(this.releaseCode.substring(1));t.buttons[s]&&t.buttons[s].pressed&&(e=!0)}}else if(this.releaseCode.includes("a")){const s=this.releaseCode.replace(/[+-]/g,""),a=parseInt(s.substring(1));this.releaseCode.startsWith("+")?t.axes[a]>.3&&(e=!0):this.releaseCode.startsWith("-")?t.axes[a]<-.3&&(e=!0):this.getAxisDelta(t,a)>.3&&(e=!0)}e||this.nextStep();return}if(this.state==="WAITING_FOR_INPUT"){let e=null;for(let s=0;s<t.buttons.length;s++)if(t.buttons[s].pressed){e=`b${s}`;break}if(!e){for(let s=0;s<t.axes.length;s++)if(this.getAxisDelta(t,s)>.6){let i=`a${s}`;if(!this.currentStep.type||this.currentStep.type==="trigger"){const l=t.axes[s];l>.5?i=`+a${s}`:l<-.5&&(i=`-a${s}`)}else this.currentStep.type==="axis_neg"&&(i=`a${s}`);e=i;break}}if(e){const s=this.checkDuplicate(e);if(s){this.flashError(s);return}this.record(this.currentStep,e)}}}}}checkDuplicate(t){const e=(a,i)=>{if(a===i)return!0;const l=a.replace(/[+-]/g,""),o=i.replace(/[+-]/g,""),h=l.startsWith("a")?l:null,b=o.startsWith("a")?o:null;if(l!==o)return!1;if(h&&b){const c=a.includes("+")||a.includes("-"),d=i.includes("+")||i.includes("-");return!c||!d?!0:a===i}return!1},s={...this.calibrationData.buttons,...this.calibrationData.axes};for(const[a,i]of Object.entries(s))if(e(i,t))return a;return null}flashError(t){const e=this.getVisSelector(t);if(e){const s=this.modal.querySelector(e);s&&(s.classList.remove("flash-error"),s.offsetWidth,s.classList.add("flash-error"))}}record(t,e){var a;const s=this.getVisSelector(t.id);s&&((a=this.modal.querySelector(s))==null||a.classList.remove("active")),t.type==="trigger"?e.includes("a")?this.calibrationData.axes[t.id]=e:this.calibrationData.buttons[t.id]=e.replace(/[+-]/g,""):t.type==="axis_neg"?this.calibrationData.axes[t.id]=e.replace(/[+-]/g,""):this.calibrationData.buttons[t.id]=e,this.state="WAITING_FOR_RELEASE",this.releaseCode=e}}class N{constructor(){this.isOpen=!1,this.selectedIndex=0,this.config={visualizer:!0,debug:!1,deadzone:.5,onsetConflict:"COMMIT"},this.options=[{key:"visualizer",label:"Visualizer",type:"toggle"},{key:"debug",label:"Diagnostics",type:"toggle"},{key:"deadzone",label:"Deadzone",type:"range",min:.1,max:.9,step:.1},{key:"onsetConflict",label:"Onset Conflict",type:"select",values:["COMMIT","IGNORE","SWITCH"]},{key:"calibrate",label:"Recalibrate Controller",type:"action"}],this.onUpdate=null,this.onAction=null,this.lastDpad={up:!1,down:!1,left:!1,right:!1}}toggle(){return this.isOpen=!this.isOpen,this.render(),this.isOpen}handleInput(t){var i,l;if(!this.isOpen||!t)return;const e=t.buttons.dpad,s=o=>e[o]&&!this.lastDpad[o];s("up")&&(this.selectedIndex=(this.selectedIndex-1+this.options.length)%this.options.length,this.render()),s("down")&&(this.selectedIndex=(this.selectedIndex+1)%this.options.length,this.render()),(t.buttons.south&&!((i=this.lastButtons)!=null&&i.south)||t.buttons.east&&!((l=this.lastButtons)!=null&&l.east))&&this.toggleOption(this.options[this.selectedIndex]),this.lastDpad={...e},this.lastButtons={south:t.buttons.south,east:t.buttons.east}}toggleOption(t){if(t.type==="action"){this.onAction&&this.onAction(t.key);return}if(t.type==="toggle")this.config[t.key]=!this.config[t.key];else if(t.type==="range"){let e=this.config[t.key]+t.step;e>t.max&&(e=t.min),this.config[t.key]=parseFloat(e.toFixed(1))}else if(t.type==="select"){const s=(t.values.indexOf(this.config[t.key])+1)%t.values.length;this.config[t.key]=t.values[s]}this.render(),this.onUpdate&&this.onUpdate(this.config)}render(){const t=document.getElementById("settings-modal"),e=document.getElementById("settings-list");if(!this.isOpen){t.style.display="none";return}t.style.display="flex",e.innerHTML="",this.options.forEach((s,a)=>{const i=document.createElement("div");i.className=`settings-item ${a===this.selectedIndex?"selected":""}`;let l="";s.type==="action"?l="➜":(l=this.config[s.key],typeof l=="boolean"&&(l=l?"ON":"OFF")),i.innerHTML=`
                <span class="settings-label">${s.label}</span>
                <span class="settings-value">${l}</span>
            `,i.addEventListener("click",()=>{this.selectedIndex=a,this.toggleOption(s)}),e.appendChild(i)})}}document.querySelector("#app").innerHTML=`
  <div class="container">
    <div class="header">
        <div id="mode-indicator"><i class="fa-solid fa-circle-half-stroke"></i></div>
        <div id="case-indicator"><i class="fa-regular fa-circle"></i></div>
        <div id="export-logs-btn" class="settings-trigger" title="Export Debug Logs"><i class="fa-solid fa-file-export"></i></div>
        <div id="settings-btn" class="settings-trigger"><i class="fa-solid fa-gear"></i></div>
    </div>
    
    <div class="editor-container">
        <textarea id="editor" readonly placeholder="Waiting for input..."></textarea>
    </div>

    <div class="visualizer" id="visualizer-container">
        <div class="joystick" id="left-joy">
            <div class="stick-point"></div>
            <div class="label">Left Stick</div>
        </div>
        <div class="joystick" id="right-joy">
            <div class="stick-point"></div>
            <div class="label">Right Stick</div>
        </div>
    </div>
    
    <div id="debug-status"></div>
  </div>
`;const E=new C,S=new w,A=new _("visualizer-container"),m=new N,v=new H(E,S.mapper,()=>{});m.onAction=r=>{r==="calibrate"&&(m.toggle(),v.start())};const I=document.getElementById("settings-btn");I&&I.addEventListener("click",()=>{m.isOpen||m.toggle()});m.onUpdate=r=>{const t=document.getElementById("visualizer-container");t&&(t.style.opacity=r.visualizer?"1":"0");const e=document.getElementById("debug-status");e&&(e.style.display=r.debug?"block":"none"),S.mapper.DEADZONE=r.deadzone,S.onsetConflictMode=r.onsetConflict};m.render();m.onUpdate(m.config);window.addEventListener("gamepadconnected",r=>{const t=r.gamepad;E.handleConnect(t),console.log(`Gamepad connected at index ${t.index}: ${t.id}.`)});window.addEventListener("gamepaddisconnected",r=>{E.handleDisconnect(r.gamepad),console.log("Gamepad disconnected.")});E.on("frame",r=>{if(v.isCalibrating){v.handleInput(r);return}const t=S.mapper.map(r),e=t==null?void 0:t.buttons.start;if(e&&!E.lastStart&&m.toggle(),E.lastStart=e,m.isOpen){m.handleInput(t);return}const s=S.processFrame(r);s&&(D(s),A.update(t,s.mode,S.mappings,S.state.syllable),U(t,r))});function D(r){const t=document.getElementById("editor");if(!t)return;let e=r.text;const s=S.state.syllable,a=S.state.caseMode,i=(n,u)=>n&&(a===2||a===1&&u?n.toUpperCase():n),l=s.onset||"",o=s.vowel,h=s.coda||"";let b=i(l,!0),c=i(o||(r.mode.startsWith("RIME")?"-":""),!l),d=i(h,!l&&!o);r.mode==="ONSET"?s.onset&&(e+=`[${b}-]`):r.mode.startsWith("RIME")?e+=`[${b}${c}${d}]`:r.mode==="PUNCTUATION"&&s.onset&&(e+=`[${s.onset}]`),t.value!==e&&(t.value=e,t.scrollTop=t.scrollHeight);const f=document.getElementById("mode-indicator"),p=document.getElementById("case-indicator");if(f){let n="";switch(r.mode){case"ONSET":n='<i class="fa-solid fa-circle-half-stroke"></i>';break;case"RIME_LEFT":n='<i class="fa-solid fa-circle-chevron-left"></i>';break;case"RIME_RIGHT":n='<i class="fa-solid fa-circle-chevron-right"></i>';break;case"PUNCTUATION":n='<i class="fa-solid fa-circle-minus"></i>';break;default:n=r.mode}f.innerHTML=n}if(p){let n="";switch(r.caseMode){case 0:n='<i class="fa-regular fa-circle"></i>';break;case 1:n='<i class="fa-regular fa-circle-up"></i>';break;case 2:n='<i class="fa-solid fa-circle-up"></i>';break}p.innerHTML=n}}function U(r,t,e){const s=document.getElementById("debug-status");if(!(!s||s.style.display==="none")&&r){const a=t.axes.map((l,o)=>`${o}:${l.toFixed(2)}`).join(" "),i=t.buttons.map((l,o)=>l.pressed?o:null).filter(l=>l!==null).join(", ");s.innerHTML=`
              Buttons: [${i}] <br>
              Raw Axes: ${a} <br>
              LT: ${r.mode.raw.lt.toFixed(2)} | RT: ${r.mode.raw.rt.toFixed(2)} <br>
              L-Stick: ${r.sticks.left.active?r.sticks.left.sector:"Center"} (${Math.round(r.sticks.left.angle)}°)<br>
              R-Stick: ${r.sticks.right.active?r.sticks.right.sector:"Center"} (${Math.round(r.sticks.right.angle)}°)
          `}}const k=document.getElementById("export-logs-btn");k&&k.addEventListener("click",()=>{const r=T.export();console.log("--- DEBUG LOG EXPORT ---"),console.log(r),console.log("------------------------"),navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(r).then(()=>{alert("Debug logs copied to clipboard!")}).catch(t=>{console.error("Clipboard API failed",t),O(r)}):O(r)});function O(r){const t=document.createElement("textarea");t.value=r,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{const e=document.execCommand("copy");alert(e?"Debug logs copied to clipboard (Fallback)!":"Failed to copy. Check Console.")}catch(e){console.error("Fallback copy failed",e),alert("Failed to copy. Check Console.")}document.body.removeChild(t)}
