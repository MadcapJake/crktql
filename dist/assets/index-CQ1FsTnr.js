(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=e(i);fetch(i.href,n)}})();class W{constructor(){this.isOpen=!1,this.onCalibrate=null,this.gamepadInfo=null,this.openTime=0,this.selectedIndex=0}toggle(){return this.isOpen?this.close():this.open(),this.isOpen}open(){this.isOpen=!0,this.openTime=Date.now(),this.selectedIndex=0,this.render()}close(){this.isOpen=!1,this.render()}setGamepadInfo(t){this.gamepadInfo=t,this.isOpen&&this.render()}handleInput(t){var n,o,r;if(!this.isOpen||!t||Date.now()-this.openTime<250)return;const{buttons:e}=t;if(e.start&&!((n=this.lastButtons)!=null&&n.start)||e.east&&!((o=this.lastButtons)!=null&&o.east)){this.close();return}const s=e.dpad,i=this.lastDpad||{up:!1,down:!1};s.down&&!i.down?this.moveSelection(1):s.up&&!i.up&&this.moveSelection(-1),e.south&&!((r=this.lastButtons)!=null&&r.south)&&this.executeAction(),this.lastButtons={start:e.start,east:e.east,south:e.south},this.lastDpad={up:s.up,down:s.down}}moveSelection(t){const e=this.getItems();this.selectedIndex=(this.selectedIndex+t+e.length)%e.length,this.render()}executeAction(){const e=this.getItems()[this.selectedIndex];if(e.type==="info"){if(this.gamepadInfo){const s=`${this.gamepadInfo.id} (Index: ${this.gamepadInfo.index})`;navigator.clipboard.writeText(s).then(()=>{this.copiedFeedback=!0,this.render(),setTimeout(()=>{this.copiedFeedback=!1,this.isOpen&&this.render()},1e3)})}}else e.type==="calibrate"?this.onCalibrate&&(this.close(),this.onCalibrate()):e.type==="done"&&this.close()}getItems(){return[{type:"info",label:"Controller Info"},{type:"calibrate",label:"Calibrate Controller"},{type:"done",label:"Done"}]}render(){const t=document.getElementById("gamepad-modal");if(!t)return;if(!this.isOpen){t.style.display="none";return}t.style.display="flex";const e=t.querySelector(".modal-content");if(e){const s=this.gamepadInfo?this.gamepadInfo.id:"No Controller Connected",i=this.gamepadInfo?`Index: ${this.gamepadInfo.index}`:"",n=this.copiedFeedback?"Copied!":"Press A to Copy",o=this.getItems();let r="<h2>Controller Status</h2>";const c=o[0].type==="info"&&this.selectedIndex===0;r+=`
                <div class="settings-item ${c?"selected":""}" 
                     style="display: block; text-align: center; margin-bottom: 1.5rem; padding: 1rem; border: 1px solid ${c?"var(--color-accent)":"transparent"}; border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 0.5rem; color: #fff;">${s}</div>
                    <div style="font-size: 0.8rem; color: #888;">${i}</div>
                    ${c?`<div style="font-size: 0.7rem; color: var(--color-accent); margin-top: 5px;">${n}</div>`:""}
                </div>
            `;const d=o[1].type==="calibrate"&&this.selectedIndex===1;r+=`
                <div class="settings-item ${d?"selected":""}" style="justify-content: center;">
                   <span class="settings-label">Calibrate Controller</span>
                </div>
            `;const u=o[2].type==="done"&&this.selectedIndex===2;r+=`
                 <div class="settings-item ${u?"selected":""} done-btn" style="justify-content: center; margin-top: 1rem;">
                   <span style="width:100%; text-align:center;">Done</span>
                </div>
            `,e.innerHTML=r;const p=e.querySelector(".settings-item:nth-child(2)");p&&(p.onclick=()=>{this.selectedIndex=0,this.executeAction()});const f=e.querySelector(".settings-item:nth-child(3)");f&&(f.onclick=()=>{this.selectedIndex=1,this.executeAction()});const l=e.querySelector(".settings-item:nth-child(4)");l&&(l.onclick=()=>{this.selectedIndex=2,this.executeAction()})}}}class z{getActiveGamepad(){const t=Object.keys(this.controllers);return t.length>0?this.controllers[t[0]]:null}constructor(){this.controllers={},this.animationFrameId=null,this.listeners={frame:[],connect:[],disconnect:[]},window.addEventListener("gamepadconnected",this.onGamepadConnected.bind(this)),window.addEventListener("gamepaddisconnected",this.onGamepadDisconnected.bind(this)),this.checkInterval=setInterval(this.scanGamepads.bind(this),500),window.addEventListener("click",()=>this.scanGamepads()),window.addEventListener("keydown",()=>this.scanGamepads())}scanGamepads(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)t[e]&&!this.controllers[t[e].index]&&this.onGamepadConnected({gamepad:t[e]})}handleConnect(t){this.onGamepadConnected({gamepad:t})}handleDisconnect(t){this.onGamepadDisconnected({gamepad:t})}onGamepadConnected(t){console.log("Gamepad connected",t.gamepad),this.controllers[t.gamepad.index]=t.gamepad,this.emit("connect",t.gamepad),Object.keys(this.controllers).length===1&&!this.animationFrameId&&(this.startPolling(),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null))}onGamepadDisconnected(t){console.log("Gamepad disconnected",t.gamepad),delete this.controllers[t.gamepad.index],this.emit("disconnect",t.gamepad),Object.keys(this.controllers).length===0&&this.stopPolling()}startPolling(){const t=()=>{this.poll(),this.animationFrameId=requestAnimationFrame(t)};this.animationFrameId=requestAnimationFrame(t)}stopPolling(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}poll(){const t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];for(let e=0;e<t.length;e++)if(t[e]){this.controllers[t[e].index]=t[e],this.emit("frame",t[e]);break}}on(t,e){this.listeners[t]&&this.listeners[t].push(e)}emit(t,e){this.listeners[t]&&this.listeners[t].forEach(s=>s(e))}}class V{constructor(){this.mappings={},this.addMapping("03000000c82d000009600000","8BitDo Pro 3","a:b0,b:b1,x:b2,y:b3,back:b6,start:b7,guide:b8,leftstick:b9,rightstick:b10,leftshoulder:b4,rightshoulder:b5,dpup:h0.1,dpdown:h0.4,dpleft:h0.8,dpright:h0.2,leftx:a0,lefty:a1,rightx:a3,righty:a4,lefttrigger:a2,righttrigger:a5"),this.addMapping("2dc8-6009","8BitDo Pro 3 (User Config)","a:b0,b:b1,x:b2,y:b3,back:b10,start:b11,leftstick:b12,rightstick:b13,leftshoulder:b6,rightshoulder:b7,dpup:h0.1,dpdown:h0.4,dpleft:h0.8,dpright:h0.2,leftx:a0,lefty:a1,rightx:a2,righty:a3,lefttrigger:a4,righttrigger:a5"),this.loadFromStorage()}addMapping(t,e,s){this.mappings[t.toLowerCase()]=this.parseMapping(s)}loadFromStorage(){try{const t=localStorage.getItem("custom_gamepad_mapping");if(t){const e=JSON.parse(t);e.key&&e.mapping&&(console.log("Loaded custom mapping for:",e.key),this.addMapping(e.key,e.name,e.mapping))}}catch(t){console.error("Failed to load custom mapping",t)}}findMapping(t){const e=t.id.toLowerCase(),s=e.match(/vendor:\s*([0-9a-f]{4})/),i=e.match(/product:\s*([0-9a-f]{4})/);if(s&&i){const n=`${s[1]}-${i[1]}`;if(this.mappings[n])return this.mappings[n]}return null}parseMapping(t){const e={buttons:{},axes:{}};return t.split(",").forEach(i=>{if(!i.includes(":"))return;const[n,o]=i.split(":");o.startsWith("b")?e.buttons[n]=parseInt(o.substring(1)):o.startsWith("a")?e.axes[n]=parseInt(o.substring(1)):o.startsWith("h")&&(e.buttons[n]={type:"hat",val:o})}),e}apply(t,e,s){}getIndices(t){const e=this.findMapping(t);return e?{axes:{lx:e.axes.leftx??0,ly:e.axes.lefty??1,rx:e.axes.rightx??2,ry:e.axes.righty??3,lt:e.axes.lefttrigger,rt:e.axes.righttrigger},buttons:{south:e.buttons.a??0,east:e.buttons.b??1,west:e.buttons.x??2,north:e.buttons.y??3,lb:e.buttons.leftshoulder??4,rb:e.buttons.rightshoulder??5,select:e.buttons.back??8,start:e.buttons.start??9,l3:e.buttons.leftstick??10,r3:e.buttons.rightstick??11,lt:e.buttons.lefttrigger,rt:e.buttons.righttrigger}}:null}}class q{constructor(){this.DEADZONE=.5,this.TRIGGER_THRESHOLD=.1,this.mappings=new V}map(t){var p,f;if(!t)return null;const e=this.mappings.getIndices(t)||this.getDefaultIndices(t),s=l=>{if(l==null)return!1;if(typeof l=="number"){const h=t.buttons[l];return h&&(h.pressed||h.value>.5)}if(typeof l=="string"){if(l.startsWith("h"))return!1;let h=0,b=0;if(l.startsWith("+a"))h=parseInt(l.slice(2)),b=1;else if(l.startsWith("-a"))h=parseInt(l.slice(2)),b=-1;else if(l.startsWith("a"))h=parseInt(l.slice(1)),b=0;else return!1;const S=t.axes[h];return b===1?S>.5:b===-1?S<-.5:Math.abs(S)>.5}return!1},i=l=>{var M;let h=(M=e.buttons.dpad)==null?void 0:M[l];if(h!==void 0)return s(h);const b=t.axes[6],S=t.axes[7];return l==="left"&&b<-.5||l==="right"&&b>.5||l==="up"&&S<-.5||l==="down"&&S>.5},n=l=>l!==void 0&&t.axes[l]!==void 0?t.axes[l]:0,o=n(e.axes.lx),r=n(e.axes.ly),c=n(e.axes.rx),m=n(e.axes.ry);let d=0,u=0;if(e.axes.lt!==void 0){let l=n(e.axes.lt);l>-1&&(d=(l+1)/2)}else if(e.buttons.lt!==void 0){const l=e.buttons.lt;if(typeof l=="number")d=((p=t.buttons[l])==null?void 0:p.value)||0;else if(typeof l=="string"&&l.startsWith("a")){const h=parseInt(l.replace(/[^0-9]/g,""));let b=n(h);b>-1&&(d=(b+1)/2)}}if(e.axes.rt!==void 0){let l=n(e.axes.rt);l>-1&&(u=(l+1)/2)}else if(e.buttons.rt!==void 0){const l=e.buttons.rt;if(typeof l=="number")u=((f=t.buttons[l])==null?void 0:f.value)||0;else if(typeof l=="string"&&l.startsWith("a")){const h=parseInt(l.replace(/[^0-9]/g,""));let b=n(h);b>-1&&(u=(b+1)/2)}}return{mode:{raw:{lt:d,rt:u},leftTrigger:d>this.TRIGGER_THRESHOLD,rightTrigger:u>this.TRIGGER_THRESHOLD,bothTriggers:d>this.TRIGGER_THRESHOLD&&u>this.TRIGGER_THRESHOLD},sticks:{left:this.processStick(o,r),right:this.processStick(c,m)},buttons:{south:s(e.buttons.south),east:s(e.buttons.east),west:s(e.buttons.west),north:s(e.buttons.north),lb:s(e.buttons.lb),rb:s(e.buttons.rb),select:s(e.buttons.select),start:s(e.buttons.start),l3:s(e.buttons.l3),r3:s(e.buttons.r3),dpad:{up:i("up"),down:i("down"),left:i("left"),right:i("right")}}}}getDefaultIndices(t){return{axes:{lx:0,ly:1,rx:2,ry:3,lt:void 0,rt:void 0},buttons:{south:0,east:1,west:2,north:3,lb:4,rb:5,lt:6,rt:7,select:8,start:9,l3:10,r3:11,dpad:{up:12,down:13,left:14,right:15}}}}processStick(t,e){const s=Math.sqrt(t*t+e*e);if(s<this.DEADZONE)return{x:0,y:0,angle:0,magnitude:0,active:!1,sector:null};let n=Math.atan2(e,t)*(180/Math.PI);return n+=90,n<0&&(n+=360),{x:t,y:e,angle:n,magnitude:s,active:!0,sector:this.getSector(n)}}getSector(t){return t>=360-22.5||t<0+22.5?"NORTH":t>=45-22.5&&t<45+22.5?"NORTH_EAST":t>=90-22.5&&t<90+22.5?"EAST":t>=135-22.5&&t<135+22.5?"SOUTH_EAST":t>=180-22.5&&t<180+22.5?"SOUTH":t>=225-22.5&&t<225+22.5?"SOUTH_WEST":t>=270-22.5&&t<270+22.5?"WEST":t>=315-22.5&&t<315+22.5?"NORTH_WEST":null}}class j{constructor(t=2e3){this.logs=[],this.maxSize=t,this.startTime=Date.now()}log(t,e,s=null){const i=Date.now()-this.startTime;this.logs.push({timestamp:i,category:t,message:e,data:s?JSON.parse(JSON.stringify(s)):null}),this.logs.length>this.maxSize&&this.logs.shift()}export(){return this.logs.map(t=>{const e=t.data?` | ${JSON.stringify(t.data)}`:"";return`[${t.timestamp}ms] [${t.category}] ${t.message}${e}`}).join(`
`)}clear(){this.logs=[],this.startTime=Date.now()}}const x=new j;class K{constructor(){this.mapper=new q,this.state={mode:"ONSET",text:"",caseMode:0,syllable:{onset:null,vowel:null,coda:null},lastInput:null,pendingChar:null,pendingStick:null,onsetOwner:null,leftStick:{sector:null,enterTime:0,locked:!1},rightStick:{sector:null,enterTime:0,locked:!1},modeSwitchTime:0},this.DWELL_THRESHOLD=60,this.onsetConflictMode="COMMIT",this.mappings={ONSET:{LEFT:{NORTH:"h",NORTH_EAST:"k",EAST:"t",SOUTH_EAST:"c",SOUTH:"f",SOUTH_WEST:"s",WEST:"n",NORTH_WEST:"l"},RIGHT:{NORTH:"y",NORTH_EAST:"g",EAST:"d",SOUTH_EAST:"z",SOUTH:"b",SOUTH_WEST:"x",WEST:"m",NORTH_WEST:"w"}},RIME:{VOWELS:{NORTH:"i",NORTH_EAST:"û",EAST:"u",SOUTH_EAST:"ô",SOUTH:"o",SOUTH_WEST:"e",WEST:"ê",NORTH_WEST:"î"},CODA:{NORTH:"k",EAST:"t",SOUTH_EAST:"c",SOUTH_WEST:"s",WEST:"n",NORTH_WEST:"l"}},PUNCTUATION:{LEFT:{NORTH:";",NORTH_EAST:"“",EAST:"¿",SOUTH_EAST:",",SOUTH:"«",SOUTH_WEST:"<",WEST:null,NORTH_WEST:null},RIGHT:{NORTH:":",NORTH_EAST:"”",EAST:"?",SOUTH_EAST:".",SOUTH:"»",SOUTH_WEST:">"}}}}processFrame(t){const e=this.mapper.map(t);if(!e)return null;let s="ONSET";if(e.mode.bothTriggers?s="PUNCTUATION":e.mode.leftTrigger?s="RIME_LEFT":e.mode.rightTrigger&&(s="RIME_RIGHT"),this.state.mode!==s){if(s==="ONSET"&&(this.state.mode==="RIME_LEFT"||this.state.mode==="RIME_RIGHT")){let n=this.getFormattedSyllable();n.length>0&&(this.typeCharacter(n),this.consumeShift()),this.clearSyllable()}this.state.mode=s,this.state.modeSwitchTime=Date.now()}return this.handleStickInput(e,this.state.lastInput),this.handleButtons(e,this.state.lastInput),this.state.lastInput=e,this.state}handleStickInput(t,e){if(!e)return;const s=Date.now(),i=(n,o,r)=>{const c=t.sticks[n],m=e.sticks[n],d=this.state[`${n}Stick`];if(c.active||(d.locked&&x.log("STICK",`${n} Unlocked`),d.locked=!1),!d.locked){if(c.active&&c.sector){if(d.sector!==c.sector)d.sector=c.sector,d.enterTime=s;else if(s-d.enterTime>this.DWELL_THRESHOLD&&d.enterTime>this.state.modeSwitchTime){if(this.state.mode==="ONSET"&&o==="onset"){const f=n==="left"?"right":"left",l=this.state[`${f}Stick`],h=t.sticks[f];if(h&&h.active&&!l.locked&&this.state.syllable.onset&&d.enterTime>l.enterTime){if(this.state.onsetOwner===n){x.log("CONFLICT_SELF",`Ignored bounce for ${n} (Owner)`);return}if(x.log("CONFLICT",`New: ${n}, Old: ${f}. Mode: ${this.onsetConflictMode}`),this.onsetConflictMode==="IGNORE")return;this.onsetConflictMode==="COMMIT"?(x.log("CONFLICT_COMMIT",`Committed ${this.state.syllable.onset}o`),this.typeCharacter(this.state.syllable.onset+"o"),this.clearSyllable(),this.consumeShift(),l.locked=!0,l.sector=null,x.log("LOCK",`${f} Locked`)):this.onsetConflictMode==="SWITCH"&&(x.log("CONFLICT_SWITCH",`Switched to ${n}`),this.clearSyllable())}}const p=r[c.sector];p&&(this.state.syllable[o]=p,o==="onset"&&(this.state.onsetOwner=n))}}else d.sector=null,d.enterTime=0,this.state.mode.startsWith("RIME")&&(this.state.syllable[o]=null);if(m.active&&!c.active&&this.state.mode==="ONSET"&&o==="onset"&&this.state.syllable.onset&&this.state.onsetOwner===n){let u=this.getFormattedSyllable();this.typeCharacter(u+"o"),this.clearSyllable(),this.consumeShift()}}};this.state.mode==="ONSET"?(i("left","onset",this.mappings.ONSET.LEFT),i("right","onset",this.mappings.ONSET.RIGHT),this.state.syllable.vowel=null,this.state.syllable.coda=null):this.state.mode==="RIME_LEFT"?(i("left","vowel",this.mappings.RIME.VOWELS),i("right","coda",this.mappings.RIME.CODA)):this.state.mode==="RIME_RIGHT"?(i("right","vowel",this.mappings.RIME.VOWELS),i("left","coda",this.mappings.RIME.CODA)):this.state.mode==="PUNCTUATION"&&(i("left","onset",this.mappings.PUNCTUATION.LEFT),i("right","onset",this.mappings.PUNCTUATION.RIGHT))}handleButtons(t,e){if(!e)return;const s=i=>t.buttons[i]&&!e.buttons[i];s("south")&&this.typeCharacter(" "),s("east")&&this.typeCharacter(`
`),s("west")&&this.deleteCharacter(),(s("l3")||s("r3"))&&(this.state.caseMode=(this.state.caseMode+1)%3,console.log("Case Mode:",["LOWER","SHIFT","CAPS"][this.state.caseMode]),this.forceUpdateBuffer())}forceUpdateBuffer(){["left","right"].forEach(t=>{var s;const e=(s=this.state.lastInput)==null?void 0:s.sticks[t];e&&e.active&&e.sector&&(this.state[`${t}Stick`].sector,e.sector)})}getFormattedSyllable(){const t=this.state.syllable,e=this.state.caseMode;let s=t.onset||"",i=t.vowel||"",n=t.coda||"";if(!s&&!i&&!n)return"";if(e===2)return(s+i+n).toUpperCase();if(e===1){if(s)return s.toUpperCase()+i+n;if(i)return i.toUpperCase()+n;if(n)return n.toUpperCase()}return s+i+n}typeCharacter(t){this.state.text+=t,console.log("Typed:",t)}deleteCharacter(){this.state.text=this.state.text.slice(0,-1)}consumeShift(){this.state.caseMode===1&&(this.state.caseMode=0)}clearSyllable(){this.state.syllable={onset:null,vowel:null,coda:null},this.state.onsetOwner=null}reset(t=""){this.state.text=t,this.clearSyllable(),this.state.mode="ONSET",this.state.caseMode=0}}class J{constructor(t){this.container=document.getElementById(t),this.leftJoy=this.container.querySelector("#left-joy"),this.rightJoy=this.container.querySelector("#right-joy"),this.createRadialSegments(this.leftJoy,"left"),this.createRadialSegments(this.rightJoy,"right")}createRadialSegments(t,e){const s=["NORTH","NORTH_EAST","EAST","SOUTH_EAST","SOUTH","SOUTH_WEST","WEST","NORTH_WEST"],i=document.createElement("div");i.className="segment-container",s.forEach((n,o)=>{const r=document.createElement("div");r.className=`segment segment-${o}`,r.dataset.sector=n;const c=document.createElement("span");c.className="segment-label",r.appendChild(c),i.appendChild(r)}),t.appendChild(i)}update(t,e,s){t&&(this.updateJoystick(this.leftJoy,t.sticks.left,e,s,"left"),this.updateJoystick(this.rightJoy,t.sticks.right,e,s,"right"))}updateJoystick(t,e,s,i,n){const o=t.querySelector(".stick-point"),r=30,c=e.x*r,m=e.y*r;o.style.transform=`translate(${c}px, ${m}px)`;const d=t.querySelectorAll(".segment");if(d.forEach(p=>{p.classList.remove("active");const f=p.querySelector(".segment-label");f.textContent=""}),e.active&&e.sector){const p=t.querySelector(`.segment[data-sector="${e.sector}"]`);p&&p.classList.add("active")}let u=null;s==="ONSET"?u=i.ONSET[n.toUpperCase()]:s==="RIME_LEFT"?(n==="left"&&(u=i.RIME.VOWELS),n==="right"&&(u=i.RIME.CODA)):s==="RIME_RIGHT"?(n==="right"&&(u=i.RIME.VOWELS),n==="left"&&(u=i.RIME.CODA)):s==="PUNCTUATION"&&(u=i.PUNCTUATION[n.toUpperCase()]),u&&d.forEach(p=>{const f=p.dataset.sector,l=u[f];l&&(p.querySelector(".segment-label").textContent=l.toUpperCase())})}}class Q{constructor(t,e,s){this.gamepadManager=t,this.inputMapper=e,this.onClose=s,this.allSteps=[{id:"south",label:"Bottom Face Button (A/Cross)"},{id:"east",label:"Right Face Button (B/Circle)"},{id:"west",label:"Left Face Button (X/Square)"},{id:"north",label:"Top Face Button (Y/Triangle)"},{id:"lb",label:"Left Bumper (L1)"},{id:"rb",label:"Right Bumper (R1)"},{id:"lt",label:"Left Trigger (L2) - Press Fully",type:"trigger"},{id:"rt",label:"Right Trigger (R2) - Press Fully",type:"trigger"},{id:"select",label:"Select / Back / View"},{id:"start",label:"Start / Menu"},{id:"l3",label:"Left Stick Click (L3)"},{id:"r3",label:"Right Stick Click (R3)"},{id:"dpad_up",label:"D-Pad Up"},{id:"dpad_down",label:"D-Pad Down"},{id:"dpad_left",label:"D-Pad Left"},{id:"dpad_right",label:"D-Pad Right"},{id:"lx",label:"Move Left Stick Left",type:"axis_neg"},{id:"ly",label:"Move Left Stick Up",type:"axis_neg"},{id:"rx",label:"Move Right Stick Left",type:"axis_neg"},{id:"ry",label:"Move Right Stick Up",type:"axis_neg"}],this.queue=[],this.skippedQueue=[],this.currentStep=null,this.calibrationData={buttons:{},axes:{}},this.isCalibrating=!1,this.state="IDLE",this.releaseCode=null,this.axisBaselines=[],this.modal=document.getElementById("calibration-modal"),this.prompt=document.getElementById("calibration-prompt"),this.skipBtn=document.getElementById("cal-skip"),this.cancelBtn=document.getElementById("cal-cancel"),this.visuals=document.querySelectorAll(".vis-btn, .vis-stick, .vis-dpad"),this.skipBtn.addEventListener("click",()=>{this.state==="INITIAL_RELEASE"?(this.updateBaselines(),this.nextStep()):this.skipStep()}),this.cancelBtn.addEventListener("click",()=>this.stop())}start(){this.isCalibrating=!0,this.calibrationData={buttons:{},axes:{}},this.queue=[...this.allSteps],this.skippedQueue=[],this.state="INITIAL_RELEASE",this.releaseCode=null,this.updateBaselines(),this.modal.style.display="flex",this.visuals.forEach(t=>{t.className=t.className.replace(/active|skipped|flash-error/g,"").trim()}),this.prompt.textContent="Checking for stuck inputs...",this.updateSkipButton("Force Start")}updateBaselines(){const t=this.gamepadManager.getActiveGamepad();t?this.axisBaselines=t.axes.map(e=>e):this.axisBaselines=[]}stop(){this.isCalibrating=!1,this.state="IDLE",this.modal.style.display="none",this.onClose&&this.onClose()}save(){const t=[],e={south:"a",east:"b",west:"x",north:"y",lb:"leftshoulder",rb:"rightshoulder",lt:"lefttrigger",rt:"righttrigger",select:"back",start:"start",l3:"leftstick",r3:"rightstick",dpad_up:"dpup",dpad_down:"dpdown",dpad_left:"dpleft",dpad_right:"dpright",lx:"leftx",ly:"lefty",rx:"rightx",ry:"righty"};for(const[n,o]of Object.entries(this.calibrationData.buttons)){const r=e[n];r&&t.push(`${r}:${o}`)}for(const[n,o]of Object.entries(this.calibrationData.axes)){const r=e[n];r&&t.push(`${r}:${o}`)}const s=t.join(","),i=this.gamepadManager.getActiveGamepad();if(i){const n=i.id.toLowerCase(),o=n.match(/vendor:\s*([0-9a-f]{4})/),r=n.match(/product:\s*([0-9a-f]{4})/);let c="user-custom";o&&r&&(c=`${o[1]}-${r[1]}`),localStorage.setItem("custom_gamepad_mapping",JSON.stringify({key:c,name:"User Calibrated",mapping:s})),this.inputMapper.mappings.loadFromStorage()}this.stop()}nextStep(){if(this.queue.length===0)if(this.skippedQueue.length>0)alert("Revisiting skipped buttons. Please map them now."),this.queue=[...this.skippedQueue],this.skippedQueue=[];else{this.save();return}this.currentStep=this.queue.shift(),this.state="WAITING_FOR_INPUT",this.updateSkipButton("Skip"),this.renderStep()}updateSkipButton(t){this.skipBtn&&(this.skipBtn.textContent=t)}skipStep(){if(!this.currentStep)return;const t=this.getVisSelector(this.currentStep.id);if(t){const e=this.modal.querySelector(t);e&&(e.classList.remove("active"),e.classList.add("skipped"))}this.skippedQueue.push(this.currentStep),this.nextStep()}renderStep(){if(!this.currentStep)return;this.prompt.textContent=this.currentStep.label;const t=this.getVisSelector(this.currentStep.id);if(t){const e=this.modal.querySelector(t);e.classList.remove("skipped"),e.classList.add("active")}}getVisSelector(t){return{south:".vis-a",east:".vis-b",west:".vis-x",north:".vis-y",lb:".vis-l-shoulder",rb:".vis-r-shoulder",lt:".vis-l-trigger",rt:".vis-r-trigger",select:".vis-select",start:".vis-start",l3:".vis-l-stick",r3:".vis-r-stick",dpad_up:".vis-dpad",dpad_down:".vis-dpad",dpad_left:".vis-dpad",dpad_right:".vis-dpad",lx:".vis-l-stick",ly:".vis-l-stick",rx:".vis-r-stick",ry:".vis-r-stick"}[t]}getAxisDelta(t,e){if(!this.axisBaselines[e]&&this.axisBaselines[e]!==0)return 0;const s=t.axes[e],i=this.axisBaselines[e];return Math.abs(s-i)}handleInput(t){if(!this.isCalibrating)return;let e=!1;for(let s=0;s<t.buttons.length;s++)if(t.buttons[s].pressed){e=!0;break}if(e){if(!this.holdStartTime)this.holdStartTime=Date.now();else if(Date.now()-this.holdStartTime>5e3){this.stop();return}}else this.holdStartTime=null;if(this.state==="INITIAL_RELEASE"){let s=null;for(let i=0;i<t.buttons.length;i++)if(t.buttons[i].pressed){s=`Button ${i}`;break}if(!s){for(let i=0;i<t.axes.length;i++)if(this.getAxisDelta(t,i)>.5){s=`Axis ${i} Moved`;break}}s?this.prompt.textContent=`Input Detected: [${s}]. Release or press 'Force Start'.`:this.nextStep();return}if(this.currentStep){if(this.state==="WAITING_FOR_RELEASE"){this.prompt.textContent="Release Button...";let s=!1;if(this.releaseCode.includes("b")){if(this.releaseCode.startsWith("b")){const i=parseInt(this.releaseCode.substring(1));t.buttons[i]&&t.buttons[i].pressed&&(s=!0)}}else if(this.releaseCode.includes("a")){const i=this.releaseCode.replace(/[+-]/g,""),n=parseInt(i.substring(1));this.releaseCode.startsWith("+")?t.axes[n]>.3&&(s=!0):this.releaseCode.startsWith("-")?t.axes[n]<-.3&&(s=!0):this.getAxisDelta(t,n)>.3&&(s=!0)}s||this.nextStep();return}if(this.state==="WAITING_FOR_INPUT"){let s=null;for(let i=0;i<t.buttons.length;i++)if(t.buttons[i].pressed){s=`b${i}`;break}if(!s){for(let i=0;i<t.axes.length;i++)if(this.getAxisDelta(t,i)>.6){let o=`a${i}`;if(!this.currentStep.type||this.currentStep.type==="trigger"){const r=t.axes[i];r>.5?o=`+a${i}`:r<-.5&&(o=`-a${i}`)}else this.currentStep.type==="axis_neg"&&(o=`a${i}`);s=o;break}}if(s){const i=this.checkDuplicate(s);if(i){this.flashError(i);return}this.record(this.currentStep,s)}}}}checkDuplicate(t){const e=(i,n)=>{if(i===n)return!0;const o=i.replace(/[+-]/g,""),r=n.replace(/[+-]/g,""),c=o.startsWith("a")?o:null,m=r.startsWith("a")?r:null;if(o!==r)return!1;if(c&&m){const d=i.includes("+")||i.includes("-"),u=n.includes("+")||n.includes("-");return!d||!u?!0:i===n}return!1},s={...this.calibrationData.buttons,...this.calibrationData.axes};for(const[i,n]of Object.entries(s))if(e(n,t))return i;return null}flashError(t){const e=this.getVisSelector(t);if(e){const s=this.modal.querySelector(e);s&&(s.classList.remove("flash-error"),s.offsetWidth,s.classList.add("flash-error"))}}record(t,e){var i;const s=this.getVisSelector(t.id);s&&((i=this.modal.querySelector(s))==null||i.classList.remove("active")),t.type==="trigger"?e.includes("a")?this.calibrationData.axes[t.id]=e:this.calibrationData.buttons[t.id]=e.replace(/[+-]/g,""):t.type==="axis_neg"?this.calibrationData.axes[t.id]=e.replace(/[+-]/g,""):this.calibrationData.buttons[t.id]=e,this.state="WAITING_FOR_RELEASE",this.releaseCode=e}}class X{constructor(){this.isOpen=!1,this.selectedIndex=0,this.config={visualizer:!0,debug:!1,deadzone:.5,onsetConflict:"COMMIT",visualizerPlacement:"BOTTOM_CENTER",cursorType:"BAR"},this.options=[{key:"visualizer",label:"Visualizer",type:"toggle"},{key:"visualizerPlacement",label:"Vis. Placement",type:"select",values:["BOTTOM_CENTER","BOTTOM_OUTER","TOP_CENTER","TOP_OUTER"]},{key:"debug",label:"Developer Mode",type:"toggle"},{key:"cursorType",label:"Cursor Type",type:"select",values:["BAR","BLOCK","UNDERLINE"]},{key:"deadzone",label:"Deadzone",type:"range",min:.1,max:.9,step:.1},{key:"onsetConflict",label:"Onset Conflict",type:"select",values:["COMMIT","IGNORE","SWITCH"]},{key:"done",label:"Done",type:"action",className:"done-btn"}],this.onUpdate=null,this.onAction=null,this.lastDpad={up:!1,down:!1,left:!1,right:!1},this.openTime=0}toggle(){return this.isOpen=!this.isOpen,this.isOpen&&(this.openTime=Date.now()),this.render(),this.isOpen}handleInput(t){var n,o;if(!this.isOpen||!t||Date.now()-this.openTime<500)return;const e=t.buttons.dpad,s=r=>e[r]&&!this.lastDpad[r];s("up")&&(this.selectedIndex=(this.selectedIndex-1+this.options.length)%this.options.length,this.render()),s("down")&&(this.selectedIndex=(this.selectedIndex+1)%this.options.length,this.render()),(t.buttons.south&&!((n=this.lastButtons)!=null&&n.south)||t.buttons.east&&!((o=this.lastButtons)!=null&&o.east))&&this.toggleOption(this.options[this.selectedIndex]),this.lastDpad={...e},this.lastButtons={south:t.buttons.south,east:t.buttons.east}}toggleOption(t){if(t.key==="done"){this.toggle();return}if(t.type==="action"){this.onAction&&this.onAction(t.key);return}if(t.type==="toggle")this.config[t.key]=!this.config[t.key];else if(t.type==="range"){let e=this.config[t.key]+t.step;e>t.max&&(e=t.min),this.config[t.key]=parseFloat(e.toFixed(1))}else if(t.type==="select"){const s=(t.values.indexOf(this.config[t.key])+1)%t.values.length;this.config[t.key]=t.values[s]}this.render(),this.onUpdate&&this.onUpdate(this.config)}render(){const t=document.getElementById("settings-modal"),e=document.getElementById("settings-list");if(!this.isOpen){t.style.display="none";return}t.style.display="flex",e.innerHTML="",this.options.forEach((s,i)=>{const n=document.createElement("div");n.className=`settings-item ${i===this.selectedIndex?"selected":""} ${s.className||""}`;let o="";s.key==="done"?n.innerHTML='<span style="width:100%; text-align:center;">Done</span>':(s.type==="action"?o="➜":(o=this.config[s.key],typeof o=="boolean"&&(o=o?"ON":"OFF")),n.innerHTML=`
                    <span class="settings-label">${s.label}</span>
                    <span class="settings-value">${o}</span>
                `),n.addEventListener("click",()=>{this.selectedIndex=i,this.toggleOption(s)}),e.appendChild(n)})}}class Z{constructor(){this.book={"0,0":{name:"Main",content:"",cursor:0}},this.currentPartKey="0,0",this.filename="untitled.htz"}loadBook(t,e){try{const s=typeof t=="string"?JSON.parse(t):t;if(this.book=s,this.filename=e||"untitled.htz",!this.book[this.currentPartKey]){const i=Object.keys(this.book);i.length>0?this.currentPartKey=i[0]:(this.book["0,0"]={name:"Main",content:"",cursor:0},this.currentPartKey="0,0")}}catch(s){throw console.error("Failed to load book",s),new Error("Invalid .htz file")}}exportBook(){return JSON.stringify(this.book,null,2)}getCurrentPart(){const t=this.book[this.currentPartKey];if(!t)return null;const[e,s]=this.currentPartKey.split(",").map(Number);return{...t,x:e,y:s}}setCurrentPartContent(t){this.book[this.currentPartKey]&&(this.book[this.currentPartKey].content=t)}setPartCursor(t){this.book[this.currentPartKey]&&(this.book[this.currentPartKey].cursor=t)}createPart(t,e){const s=`${t},${e}`;return this.book[s]?!1:(this.book[s]={name:"Unnamed",content:"",cursor:0},!0)}deletePart(t,e){const s=`${t},${e}`;if(!this.book[s])return!1;if(delete this.book[s],this.currentPartKey===s){const i=Object.keys(this.book);this.currentPartKey=i.length>0?i[0]:"0,0",i.length===0&&(this.book["0,0"]={name:"Main",content:"",cursor:0})}return!0}renamePart(t,e,s){const i=`${t},${e}`;this.book[i]&&(this.book[i].name=s)}selectPart(t,e){const s=`${t},${e}`;return this.book[s]?(this.currentPartKey=s,!0):!1}getPart(t,e){return this.book[`${t},${e}`]}getAllParts(){return this.book}}class Y{constructor(){this.mode="EDITOR",this.previousMode="EDITOR",this.onChange=null}setMode(t){this.mode!==t&&(this.previousMode=this.mode,this.mode=t,this.onChange&&this.onChange(this.mode),console.log(`Focus changed to: ${this.mode}`))}toggleOverview(){this.mode==="EDITOR"?this.setMode("OVERVIEW"):this.mode==="OVERVIEW"?this.setMode("EDITOR"):this.mode==="BOTTOM_BAR"&&this.setMode("OVERVIEW")}toggleBottomBar(){this.mode==="BOTTOM_BAR"?this.setMode(this.previousMode==="BOTTOM_BAR"?"EDITOR":this.previousMode):this.setMode("BOTTOM_BAR")}}class tt{constructor(t,e){this.container=document.getElementById(t),this.config=e||{},this.items=["export-logs-btn","gamepad-btn","settings-btn","new-book-btn","save-book-btn","open-book-btn"],this.selectedIndex=0,this.isActive=!1,this.lastDpad={left:!1,right:!1},this.lastAction=!1}activate(){this.isActive=!0;const t=this.items.indexOf("open-book-btn");t!==-1&&(this.selectedIndex=t),this.render()}deactivate(){this.isActive=!1,this.render()}handleInput(t){if(!this.isActive||!t)return;const e=t.buttons.dpad;e.right&&!this.lastDpad.right&&(this.selectedIndex=(this.selectedIndex+1)%this.items.length,this.render()),e.left&&!this.lastDpad.left&&(this.selectedIndex=(this.selectedIndex-1+this.items.length)%this.items.length,this.render());const s=t.buttons.south;s&&!this.lastAction&&this.triggerAction(this.items[this.selectedIndex]),this.lastDpad={...e},this.lastAction=s}triggerAction(t){var e;(e=document.getElementById(t))==null||e.click()}render(){this.container&&(this.isActive?this.container.classList.add("nav-active"):this.container.classList.remove("nav-active"),this.items.forEach((t,e)=>{const s=document.getElementById(t);s&&(this.isActive&&e===this.selectedIndex?s.classList.add("nav-selected"):s.classList.remove("nav-selected"))}))}}class et{constructor(t,e){this.container=document.getElementById(t),this.bookManager=e,this.cursor={x:0,y:0},this.lastMove=0,this.lastButtons={},this.holdStartTime=null,this.deleteTriggered=!1}activate(){this.container&&(this.container.style.display="block"),this.render()}deactivate(){this.container&&(this.container.style.display="none")}handleInput(t){if(!t)return;const e=t.buttons.dpad,s=Date.now();if(s-this.lastMove>150){let i=!1;e.up&&(this.cursor.y++,i=!0),e.down&&(this.cursor.y--,i=!0),e.left&&(this.cursor.x--,i=!0),e.right&&(this.cursor.x++,i=!0),i&&(this.lastMove=s,this.render())}if(t.buttons.south&&!this.lastButtons.south&&(this.bookManager.getPart(this.cursor.x,this.cursor.y)?(this.bookManager.selectPart(this.cursor.x,this.cursor.y),window.dispatchEvent(new CustomEvent("request-editor-focus"))):(this.bookManager.createPart(this.cursor.x,this.cursor.y),this.render())),t.buttons.west?(this.holdStartTime||(this.holdStartTime=s),s-this.holdStartTime>1e3&&!this.deleteTriggered&&(this.bookManager.deletePart(this.cursor.x,this.cursor.y),this.deleteTriggered=!0,this.render())):(this.holdStartTime=null,this.deleteTriggered=!1),t.buttons.north&&!this.lastButtons.north&&!this.holdStartTime){const i=this.bookManager.getPart(this.cursor.x,this.cursor.y);i&&window.dispatchEvent(new CustomEvent("request-rename",{detail:{x:this.cursor.x,y:this.cursor.y,name:i.name}}))}this.lastButtons={...t.buttons}}render(){if(!this.container)return;this.container.innerHTML="";const t=this.container.clientWidth/2,e=this.container.clientHeight/2,s=140,i=180,n=40,o=2;for(let c=-o;c<=o;c++)for(let m=-o;m<=o;m++){const d=this.cursor.x+c,u=this.cursor.y-m,p=t+c*(s+n)-s/2,f=e+m*(i+n)-i/2,l=this.bookManager.getPart(d,u),h=document.createElement("div");h.className="grid-part",h.style.left=`${p}px`,h.style.top=`${f}px`,c===0&&m===0&&h.classList.add("selected"),l?h.innerHTML=`
                        <div class="grid-part-thumb">${l.content.substring(0,50)}...</div>
                        <div class="grid-part-name">${l.name}</div>
                    `:(h.className+=" grid-empty-slot",h.innerHTML='<div style="color:#444; font-size: 2rem;">+</div>'),this.container.appendChild(h)}const r=document.createElement("div");r.style.position="absolute",r.style.top="10px",r.style.left="10px",r.style.color="#666",r.innerText=`Pos: ${this.cursor.x}, ${this.cursor.y}`,this.container.appendChild(r)}}document.querySelector("#app").innerHTML=`
  <div class="container">
    <div class="visualizer" id="visualizer-container">
        <div class="joystick" id="left-joy">
            <div class="stick-point"></div>
        </div>
        <div class="joystick" id="right-joy">
            <div class="stick-point"></div>
        </div>
    </div>

    <div id="grid-overview"></div>
    

    
    <div id="confirm-modal" class="modal-overlay" style="display: none; z-index: 200;">
        <div class="modal-content">
            <h2 id="confirm-title">Confirm</h2>
            <p id="confirm-message" style="margin-bottom: 2rem; color: #ccc; text-align: center;">Are you sure?</p>
            <div class="modal-footer">Press START to Confirm, B to Cancel</div>
        </div>
    </div>

    <div id="gamepad-modal" class="modal-overlay" style="display: none; z-index: 151;">
        <div class="modal-content"></div>
    </div>

    <div class="editor-container">
        <div id="editor-view" class="custom-editor" tabindex="0"></div>
    </div>

    <div class="bottom-bar" id="bottom-bar">
        <div id="mode-indicator"><i class="fa-solid fa-circle-half-stroke"></i></div>
        <div id="case-indicator"><i class="fa-regular fa-circle"></i></div>
        <div class="header-actions">
            <div id="export-logs-btn" class="settings-trigger" title="Export Debug Logs"><i class="fa-solid fa-file-export"></i></div>
            <div id="gamepad-btn" class="settings-trigger" title="Controller Info"><i class="fa-solid fa-gamepad"></i></div>
            <div id="settings-btn" class="settings-trigger"><i class="fa-solid fa-gear"></i></div>
            <div id="new-book-btn" class="settings-trigger" title="New Book"><i class="fa-solid fa-book-medical"></i></div>
            <div id="save-book-btn" class="settings-trigger" title="Save Book"><i class="fa-regular fa-floppy-disk"></i></div>
            <div id="open-book-btn" class="settings-trigger" title="Open Book"><i class="fa-solid fa-book-open"></i></div>
        </div>
        <div id="notification-area"></div>
    </div>
    
    <div id="debug-status"></div>
  </div>
`;const E=new X,y=new z,T=new K,I=new W;I.onCalibrate=()=>{document.getElementById("calibration-modal")&&(g.setMode("CALIBRATION"),B.start())};window.addEventListener("gamepadconnected",a=>{const t=document.getElementById("gamepad-btn");t&&(t.classList.remove("shake","status-warning"),t.classList.add("status-success"),setTimeout(()=>t.classList.remove("status-success"),1e3)),C("Game controller connected!"),I.setGamepadInfo({id:a.gamepad.id,index:a.gamepad.index})});window.addEventListener("gamepaddisconnected",a=>{const t=document.getElementById("gamepad-btn");t&&t.classList.add("shake","status-warning"),C("No game controller connected"),I.setGamepadInfo(null)});setTimeout(()=>{const a=navigator.getGamepads?navigator.getGamepads():[],t=document.getElementById("gamepad-btn");t&&(!a[0]||!a[0].connected)&&(t.classList.add("shake","status-warning"),C("No game controller connected"))},1e3);const _=new J("visualizer-container");let L={up:!1,down:!1,left:!1,right:!1},w=0;const v=new Z,g=new Y,N=new tt("bottom-bar"),O=new et("grid-overview",v),B=new Q(y,T.mapper,()=>{g.setMode("EDITOR")});g.onChange=a=>{if(console.log("Mode changed to:",a),a==="OVERVIEW")O.activate(),document.querySelector(".editor-container").style.display="none",document.getElementById("visualizer-container").style.display="none";else if((a==="EDITOR"||a==="RENAMING")&&(O.deactivate(),document.querySelector(".editor-container").style.display="flex",document.getElementById("visualizer-container").style.display="flex",a==="EDITOR")){const t=v.getCurrentPart();t&&(T.reset(t.content),w=t.content.length,L={up:!1,down:!1,left:!1,right:!1})}a==="BOTTOM_BAR"?N.activate():N.deactivate(),D(a)};let k=null;function D(a){const t=document.getElementById("notification-area");if(!t||k)return;let e="";if(a==="OVERVIEW")e=`
            <span class="notification-persistent">
                <i class="fa-solid fa-x icon-blue"></i> Hold 3s: Delete Part&emsp;
                <i class="fa-solid fa-y icon-yellow"></i> Rename Part&emsp;
                <i class="fa-solid fa-a icon-green"></i> Open Part
            </span>
        `;else if(a==="RENAMING"){const s=v.getCurrentPart();e=`
            <span class="notification-persistent">
                <i class="fa-solid fa-b icon-red"></i> Rename Part (Prior Name: ${s?s.name:"Unknown"})&emsp;
                <i class="fa-solid fa-square-caret-left icon-grey"></i> <strong>Select:</strong> Cancel Rename
            </span>
        `}else if(a==="EDITOR"){const s=v.getCurrentPart();s&&(e=`
            <span class="notification-persistent" style="font-family: monospace;">
               ${s.name} <span style="color: #888;">(${s.x}, ${s.y})</span>
            </span>
          `)}else a==="CALIBRATION"&&(e=`
        <span class="notification-persistent">
             <i class="fa-solid fa-asterisk" style="color: violet;"></i> 
             <strong>Hold any button 5 seconds:</strong> Cancel calibration
        </span>
      `);t.innerHTML=e}function C(a){const t=document.getElementById("notification-area");if(!t)return;k&&(clearTimeout(k),k=null),t.innerHTML="";const e=document.createElement("div");e.className="notification-toast",e.innerText=a,t.appendChild(e),k=setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),k=null,D(g.mode)},3e3)}let R=null;function st(a,t){const e=document.getElementById("confirm-modal"),s=document.getElementById("confirm-message");e&&s&&(s.innerText=a,e.style.display="flex",R=t,g.setMode("DIALOG_CONFIRM"))}E.onAction=a=>{a==="calibrate"&&(E.toggle(),B.start())};var G;(G=document.getElementById("new-book-btn"))==null||G.addEventListener("click",()=>{st("Create new book? Unsaved changes will be lost.",()=>{v.loadBook({},"untitled.htz"),v.createPart(0,0),g.setMode("EDITOR"),O.render(),C("New Book Created")})});var U;(U=document.getElementById("open-book-btn"))==null||U.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.accept=".htz,.json",a.onchange=t=>{const e=t.target.files[0];if(!e)return;const s=new FileReader;s.onload=i=>{try{v.loadBook(i.target.result,e.name),g.setMode("EDITOR");const n=v.getCurrentPart();n?T.reset(n.content):T.reset(""),O.render()}catch(n){C("Failed to load book: "+n.message)}},s.readAsText(e)},a.click()});var F;(F=document.getElementById("save-book-btn"))==null||F.addEventListener("click",()=>{const a=v.exportBook(),t=v.filename||"my_book.htz",e=new Blob([a],{type:"application/json"}),s=URL.createObjectURL(e),i=document.createElement("a");i.href=s,i.download=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),C(`Book saved as ${t}`)});const H=document.getElementById("settings-btn");H&&(H.addEventListener("click",()=>{E.isOpen||E.toggle()}),document.getElementById("gamepad-btn").addEventListener("click",()=>{I.isOpen||I.toggle()}));E.onUpdate=a=>{const t=document.getElementById("visualizer-container"),e=document.getElementById("debug-status"),s=document.getElementById("editor-view");if(t){t.style.opacity=a.visualizer?"1":"0",t.className="visualizer";const n=a.visualizerPlacement||"BOTTOM_CENTER";n==="BOTTOM_CENTER"?t.classList.add("vis-bottom-center"):n==="BOTTOM_OUTER"?t.classList.add("vis-bottom-outer"):n==="TOP_CENTER"?t.classList.add("vis-top-center"):n==="TOP_OUTER"&&t.classList.add("vis-top-outer"),s&&(s.style.paddingTop="2rem",s.style.paddingBottom="2rem",n.startsWith("TOP")?s.style.paddingTop="320px":s.style.paddingBottom="320px")}const i=document.getElementById("export-logs-btn");if(e){e.style.display=a.debug?"block":"none",i&&(i.style.display=a.debug?"flex":"none"),e.className="";let n="debug-bottom-right";a.visualizer&&a.visualizerPlacement&&a.visualizerPlacement.startsWith("BOTTOM")&&(n="debug-top-right"),e.classList.add(n)}if(T.mapper.DEADZONE=a.deadzone,T.onsetConflictMode=a.onsetConflict,g.mode==="EDITOR"||g.mode==="BOTTOM_BAR"||E.isOpen){const n=v.getCurrentPart();n&&A(n)}};E.render();E.onUpdate(E.config);D(g.mode);window.addEventListener("gamepadconnected",a=>{const t=a.gamepad;y.handleConnect(t),console.log(`Gamepad connected at index ${t.index}: ${t.id}.`)});window.addEventListener("gamepaddisconnected",a=>{y.handleDisconnect(a.gamepad),console.log("Gamepad disconnected.")});window.addEventListener("request-editor-focus",()=>{g.setMode("EDITOR")});window.addEventListener("request-rename",a=>{const{x:t,y:e,name:s}=a.detail;T.reset(s?s.trim():""),g.renameTarget={x:t,y:e,oldName:s},g.setMode("RENAMING")});y.on("frame",a=>{var i;if(B.isCalibrating){B.handleInput(a);return}const t=T.mapper.map(a);if(I.isOpen){if(t!=null&&t.buttons.start&&!y.lastStart){I.close(),g.setMode("EDITOR"),y.lastStart=!0;return}I.handleInput(t);return}const e=t==null?void 0:t.buttons.start,s=t==null?void 0:t.buttons.select;if(E.isOpen){e&&!y.lastStart?(E.toggle(),g.setMode("EDITOR")):E.handleInput(t),y.lastStart=e,y.lastSelect=s;return}switch(g.mode!=="DIALOG"&&e&&!y.lastStart&&g.toggleBottomBar(),g.mode!=="DIALOG"&&g.mode!=="RENAMING"&&s&&!y.lastSelect&&g.toggleOverview(),g.mode){case"EDITOR":const n=t.buttons.dpad;y.lastDpad;const o=v.getCurrentPart();if(!o)break;let r=o.cursor||0;const c=o.content||"";let m=!1;const d=f=>n[f]&&!L[f];d("left")&&(r=Math.max(0,r-1),m=!0),d("right")&&(r=Math.min(c.length,r+1),m=!0),m&&v.setPartCursor(r),L={...n};const u=T.processFrame(a);if(u){const f=u.text,l=f.length-w;if(l!==0){let h=c,b=r;if(l>0){const S=f.slice(w);h=c.slice(0,r)+S+c.slice(r),b+=l}else{const S=-l,M=Math.max(0,r-S);h=c.slice(0,M)+c.slice(r),b=M}v.setCurrentPartContent(h),v.setPartCursor(b),w=f.length}A(v.getCurrentPart()),_.update(t,u.mode,T.mappings,T.state.syllable)}break;case"OVERVIEW":O.handleInput(t);break;case"BOTTOM_BAR":N.handleInput(t);break;case"RENAMING":const p=T.processFrame(a);if(p&&(A({content:p.text,cursor:p.text.length}),_.update(t,p.mode,T.mappings,T.state.syllable)),t.buttons.east&&!((i=y.lastButtons)!=null&&i.east)){const f=T.state.text,l=g.renameTarget;l&&v.renamePart(l.x,l.y,f),g.setMode("OVERVIEW"),O.render()}t.buttons.select&&!y.lastSelect&&g.setMode("OVERVIEW"),y.lastButtons={...t.buttons};break;case"DIALOG_CONFIRM":e&&!y.lastStart&&(R&&R(),document.getElementById("confirm-modal").style.display="none",R=null),t.buttons.east&&(document.getElementById("confirm-modal").style.display="none",R=null,g.setMode(g.previousMode||"EDITOR"));break}y.lastStart=e,y.lastSelect=s,nt(t,a)});function A(a){const t=document.getElementById("editor-view");if(!t||!a)return;const e=a.content||"",s=a.cursor||0,i=T.getFormattedSyllable(),n=f=>f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>").replace(/ /g,"&nbsp;"),o=n(e.slice(0,s)),r=e.slice(s),c=n(r),m=i?`<span class="pending-text">${n(i)}</span>`:"";let d="";const u=E.config.cursorType||"BAR";if(u==="BAR")d='<span class="cursor cursor-bar"></span>',t.innerHTML=o+m+d+c;else{let f=r.length>0?r[0]:" ",l=r.length>0?r.slice(1):"";const h=n(f),b=n(l);d=`<span class="cursor ${u==="BLOCK"?"cursor-block":"cursor-underline"}">${h}</span>`,t.innerHTML=o+m+d+b}const p=t.querySelector(".cursor");p&&p.scrollIntoView({block:"nearest",inline:"nearest"})}it();function it(){const a=document.getElementById("mode-indicator"),t=document.getElementById("case-indicator"),e=T.state;if(a){let s="";switch(e.mode){case"ONSET":s='<i class="fa-solid fa-circle-half-stroke"></i>';break;case"RIME_LEFT":s='<i class="fa-solid fa-circle-chevron-left"></i>';break;case"RIME_RIGHT":s='<i class="fa-solid fa-circle-chevron-right"></i>';break;case"PUNCTUATION":s='<i class="fa-solid fa-circle-minus"></i>';break;default:s=e.mode}a.innerHTML=s}if(t)switch(e.caseMode){}}function nt(a,t,e){const s=document.getElementById("debug-status");if(!(!s||s.style.display==="none")&&a){const i=t.axes.map((o,r)=>`${r}:${o.toFixed(2)}`).join(" "),n=t.buttons.map((o,r)=>o.pressed?r:null).filter(o=>o!==null).join(", ");s.innerHTML=`
              Buttons: [${n}] <br>
              Raw Axes: ${i} <br>
              LT: ${a.mode.raw.lt.toFixed(2)} | RT: ${a.mode.raw.rt.toFixed(2)} <br>
              L-Stick: ${a.sticks.left.active?a.sticks.left.sector:"Center"} (${Math.round(a.sticks.left.angle)}°)<br>
              R-Stick: ${a.sticks.right.active?a.sticks.right.sector:"Center"} (${Math.round(a.sticks.right.angle)}°)
          `}}const P=document.getElementById("export-logs-btn");P&&P.addEventListener("click",()=>{const a=x.export();console.log("--- DEBUG LOG EXPORT ---"),console.log(a),console.log("------------------------"),navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(a).then(()=>{alert("Debug logs copied to clipboard!")}).catch(t=>{console.error("Clipboard API failed",t),$(a)}):$(a)});function $(a){const t=document.createElement("textarea");t.value=a,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t),t.focus(),t.select();try{const e=document.execCommand("copy");alert(e?"Debug logs copied to clipboard (Fallback)!":"Failed to copy. Check Console.")}catch(e){console.error("Fallback copy failed",e),alert("Failed to copy. Check Console.")}document.body.removeChild(t)}
